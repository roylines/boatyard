#!/bin/bash

if [ $# -ne 2 ]
then
  echo "Usage: launch <name> <type>"
  exit 1
fi

DROPLET_NAME=$1
DROPLET_SIZEID=66
DROPLET_IMAGEID=562354 # centos 6.4 x64 (use tugboat images -g to see them)
DROPLET_REGIONID=1
SHIP_TYPE=$2

tugboat info $DROPLET_NAME

DROPLET_EXISTS=$?
set -e

# create droplet if it doesn't exist
if [ $DROPLET_EXISTS -ne 0 ]
	then
	tugboat create $DROPLET_NAME -s $DROPLET_SIZEID -i $DROPLET_IMAGEID -r $DROPLET_REGIONID -k $DIGITAL_OCEAN_SSH
fi

# wait for active
tugboat wait $DROPLET_NAME

# work out ipaddress
IP=`tugboat info $DROPLET_NAME | grep IP | awk '{ print $2 }'`
echo "$DROPLET_NAME is launched on $IP"

if [ $DROPLET_EXISTS -ne 0 ]
	then
	# remove old ipaddress from known hosts as it's probably changed ?
	ssh-keygen -R $IP 
fi

# update
echo 'updating droplet'
ssh root@$IP "/usr/bin/yum -y update"

# install puppet
echo 'installing puppet'
set +e
#ssh root@$IP "/bin/rpm -Uvh http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm"
ssh root@$IP "/bin/rpm -Uvh http://yum.puppetlabs.com/el/6/products/i386/puppetlabs-release-6-7.noarch.rpm"
set -e
ssh root@$IP "/usr/bin/yum -y install puppet"

# apply puppet plans
ssh root@$IP "/bin/mkdir -p /plans"
pushd "./plans/$SHIP_TYPE"
scp -r "." root@$IP:/plans
popd
ssh root@$IP "puppet apply /plans/default.pp"

# finished
tugboat info $DROPLET_NAME